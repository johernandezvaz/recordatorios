{% extends 'base.html' %}
{% load static %}

{% block title %}Recordatorio - {{ recordatorio.documento.titulo }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'recordatorio_list' %}">Recordatorios</a></li>
        <li class="breadcrumb-item active">Revisión {{ recordatorio.pk }}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="bi bi-calendar-check me-2"></i>Detalles del Recordatorio de Revisión
                </h6>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Documento:</strong></div>
                    <div class="col-sm-9">
                        <a href="{{ recordatorio.documento.get_absolute_url }}" class="text-decoration-none">
                            {{ recordatorio.documento.titulo }}
                        </a>
                        <br><small class="text-muted">{{ recordatorio.documento.codigo_documento }}</small>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Estado:</strong></div>
                    <div class="col-sm-9">
                        <span class="badge bg-{% if recordatorio.estado == 'completado' %}success{% elif recordatorio.estado == 'en_proceso' %}warning{% elif recordatorio.estado == 'cancelado' %}danger{% else %}secondary{% endif %} fs-6">
                            {{ recordatorio.get_estado_display }}
                        </span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Prioridad:</strong></div>
                    <div class="col-sm-9">
                        <span class="badge bg-{% if recordatorio.prioridad == 'critica' %}danger{% elif recordatorio.prioridad == 'alta' %}warning{% elif recordatorio.prioridad == 'media' %}info{% else %}secondary{% endif %} fs-6">
                            {{ recordatorio.get_prioridad_display }}
                        </span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Fecha de Revisión:</strong></div>
                    <div class="col-sm-9">{{ recordatorio.fecha_revision|date:"d/m/Y H:i" }}</div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Próxima Revisión:</strong></div>
                    <div class="col-sm-9">
                        {% if recordatorio.fecha_proxima_revision %}
                            {{ recordatorio.fecha_proxima_revision|date:"d/m/Y H:i" }}
                            {% if recordatorio.es_vencido %}
                                <br><small class="text-danger"><i class="bi bi-exclamation-triangle"></i> Vencido hace {{ recordatorio.dias_hasta_revision|abs_value }} días</small>
                            {% elif recordatorio.es_proximo_a_vencer %}
                                <br><small class="text-warning"><i class="bi bi-clock"></i> Vence en {{ recordatorio.dias_hasta_revision }} días</small>
                            {% else %}
                                <br><small class="text-info"><i class="bi bi-calendar"></i> En {{ recordatorio.dias_hasta_revision }} días</small>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">No definida</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Revisor:</strong></div>
                    <div class="col-sm-9">{{ recordatorio.revisor.get_full_name|default:recordatorio.revisor.username }}</div>
                </div>
                
                {% if recordatorio.fecha_completado %}
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Fecha de Completado:</strong></div>
                    <div class="col-sm-9">{{ recordatorio.fecha_completado|date:"d/m/Y H:i" }}</div>
                </div>
                {% endif %}
                
                {% if recordatorio.observaciones %}
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Observaciones:</strong></div>
                    <div class="col-sm-9">{{ recordatorio.observaciones|linebreaks }}</div>
                </div>
                {% endif %}
                
                {% if recordatorio.hallazgos %}
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Hallazgos:</strong></div>
                    <div class="col-sm-9">
                        <div class="bg-light p-3 rounded">
                            {{ recordatorio.hallazgos|linebreaks }}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if recordatorio.acciones_correctivas %}
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Acciones Correctivas:</strong></div>
                    <div class="col-sm-9">
                        <div class="bg-warning bg-opacity-10 p-3 rounded border-start border-warning border-4">
                            {{ recordatorio.acciones_correctivas|linebreaks }}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-sm-3"><strong>Fecha de Creación:</strong></div>
                    <div class="col-sm-9">{{ recordatorio.fecha_creacion|date:"d/m/Y H:i" }}</div>
                </div>
            </div>
            
            <div class="card-footer">
                <div class="btn-group" role="group">
                    {% if recordatorio.estado != 'completado' %}
                    <a href="{% url 'recordatorio_editar' recordatorio.pk %}" class="btn btn-warning">
                        <i class="bi bi-pencil me-1"></i>Editar
                    </a>
                    {% endif %}
                    
                    {% if recordatorio.estado == 'pendiente' or recordatorio.estado == 'en_proceso' %}
                    <a href="{% url 'recordatorio_completar' recordatorio.pk %}" 
                       class="btn btn-success"
                       onclick="return confirm('¿Está seguro de marcar este recordatorio como completado?')">
                        <i class="bi bi-check-lg me-1"></i>Marcar Completado
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'recordatorio_list' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left me-1"></i>Volver
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Información del documento -->
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="bi bi-file-text me-2"></i>Información del Documento
                </h6>
            </div>
            <div class="card-body">
                <h6>{{ recordatorio.documento.titulo }}</h6>
                <p class="text-muted small">{{ recordatorio.documento.codigo_documento }}</p>
                
                <div class="mb-2">
                    <strong>Tipo:</strong> 
                    <span class="badge bg-secondary">{{ recordatorio.documento.tipo.nombre }}</span>
                </div>
                
                <div class="mb-2">
                    <strong>Versión:</strong> {{ recordatorio.documento.version }}
                </div>
                
                <div class="mb-2">
                    <strong>Estado:</strong> 
                    <span class="badge bg-{% if recordatorio.documento.estado == 'aprobado' %}success{% elif recordatorio.documento.estado == 'revision' %}warning{% elif recordatorio.documento.estado == 'obsoleto' %}danger{% else %}secondary{% endif %}">
                        {{ recordatorio.documento.get_estado_display }}
                    </span>
                </div>
                
                <div class="mt-3">
                    <a href="{{ recordatorio.documento.get_absolute_url }}" class="btn btn-outline-info btn-sm w-100">
                        <i class="bi bi-eye me-1"></i>Ver Documento Completo
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Acciones rápidas -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="bi bi-lightning me-2"></i>Acciones Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'recordatorio_crear' %}?documento_id={{ recordatorio.documento.pk }}" 
                       class="btn btn-outline-success btn-sm">
                        <i class="bi bi-calendar-plus me-2"></i>Nueva Revisión
                    </a>
                    
                    <a href="{% url 'recordatorio_list' %}?documento={{ recordatorio.documento.pk }}" 
                       class="btn btn-outline-info btn-sm">
                        <i class="bi bi-list-ul me-2"></i>Todas las Revisiones
                    </a>
                    
                    <a href="{% url 'documento_editar' recordatorio.documento.pk %}" 
                       class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-pencil me-2"></i>Editar Documento
                    </a>
                    
                    <button onclick="window.print()" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-printer me-2"></i>Imprimir Reporte
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Función para imprimir solo el contenido relevante
window.addEventListener('beforeprint', function() {
    document.body.classList.add('printing');
});

window.addEventListener('afterprint', function() {
    document.body.classList.remove('printing');
});

// Agregar estilos de impresión dinámicamente
const printStyles = `
    @media print {
        .navbar, .breadcrumb, .card-footer, .btn { display: none !important; }
        .card { border: 1px solid #000 !important; box-shadow: none !important; }
        .card-header { background: #f8f9fa !important; color: #000 !important; }
        body { font-size: 12px; }
    }
`;

const styleSheet = document.createElement("style");
styleSheet.textContent = printStyles;
document.head.appendChild(styleSheet);
</script>
{% endblock %}